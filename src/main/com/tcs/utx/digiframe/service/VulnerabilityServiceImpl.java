package com.tcs.utx.digiframe.service;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.tcs.utx.digiframe.controller.BrandingDetailsController;
import com.tcs.utx.digiframe.controller.HelpAPI;
import com.tcs.utx.digiframe.dao.ManageOptionsDAO;
import com.tcs.utx.digiframe.dao.ProgramDAO;
import com.tcs.utx.digiframe.dao.VulnerabilityDAO;
import com.tcs.utx.digiframe.exception.UserDefinedException;
import com.tcs.utx.digiframe.model.Etldata;
import com.tcs.utx.digiframe.model.KeyValuePair;
import com.tcs.utx.digiframe.model.TempAccess;
import com.tcs.utx.digiframe.model.UpdateStatus;
import com.tcs.utx.digiframe.model.Vulnerability;
import com.tcs.utx.digiframe.util.TSSVStringUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Service
public class VulnerabilityServiceImpl implements VulnerabilityService {

	private static final Logger LOG = LoggerFactory.getLogger(HelpAPI.class);

	@Autowired
	private VulnerabilityDAO bountyDAO;

	@Autowired
	private ProgramDAO programDAO;

	@Autowired
	private ManageOptionsService managaeOptionsService;

	@Autowired
	private ProgramService programService;

	@Override
	public int reportvuln(Vulnerability user) {
		return this.bountyDAO.reportvuln(user);
	}

	@Override
	public List<Map<String, Object>> getAllvulnerabilities() {
		return this.bountyDAO.getAllvulnerabilities();
	}

	@Override
	public List<Map<String, Object>> getVulnerabilityById(int id) {
		return this.bountyDAO.getVulnerabilityById(id);
	}

	@Override
	public List<Map<String, Object>> getVulnByProject(int projectid) {
		return this.bountyDAO.getVulnByProject(projectid);
	}

	@Override
	public void updateVulnStatus(int srno, String status, int approver, int approved_amount, String rejectRemarks) {
		this.bountyDAO.updateVulnStatus(srno, status, approver, approved_amount, rejectRemarks);
	}

	@Override
	public int updateVulnerability(Vulnerability user) {
		return this.bountyDAO.updateVulnerability(user);
	}

	@Override
	public List<Map<String, Object>> getVulnCategory() {
		return this.bountyDAO.getVulnCategory();
	}

	@Override
	public String validateVuln(Vulnerability vuln) {

		int emp_id = BrandingDetailsController.getUser();
		Map<String, Object> programDetails = this.programService.getProjectById(vuln.getProgramid(), emp_id).get(0);
		if ("DEACTIVE".equals(programDetails.get("status"))) {
			return "Vulnerability cannot be reported in expired program";
		}

		if (vuln.getProgramid() < 1) {
			return "Program is not proper";
		} else if (vuln.getTitle() == null || vuln.getTitle().length() < 2 || vuln.getTitle().length() > 1000
				|| "".equals(vuln.getTitle().trim())
				|| !TSSVStringUtil.matchPattern(vuln.getTitle(), TSSVStringUtil.PATTERN_ALPHANUMERICSPACE)) {
			return "Please enter proper title";
		} else if (vuln.getDescription() == null || vuln.getDescription().length() < 2
				|| vuln.getDescription().length() > 10000 || "".equals(vuln.getDescription().trim())
				|| !TSSVStringUtil.matchPattern(vuln.getDescription(), TSSVStringUtil.PATTERN_FOR_DESCRIPTION)) {
			return "Please enter proper Description";
		} else if (vuln.getImpact() == null || vuln.getImpact().length() < 2 || vuln.getImpact().length() > 10000
				|| "".equals(vuln.getImpact().trim())
				|| !TSSVStringUtil.matchPattern(vuln.getImpact(), TSSVStringUtil.PATTERN_FOR_DESCRIPTION)) {
			return "Please enter proper Impact";
		} else if (vuln.getReplication() == null || vuln.getReplication().length() < 2) {
			return "Please enter proper Steps to Replicate";
		} else if (vuln.getRemediation() == null || vuln.getRemediation().length() < 2
				|| vuln.getRemediation().length() > 10000 || "".equals(vuln.getRemediation().trim())
				|| !TSSVStringUtil.matchPattern(vuln.getRemediation(), TSSVStringUtil.PATTERN_MARKDOWN)) {
			return "Please enter proper Remedition";
		} 
		else if (vuln.getExtreferences() == null || vuln.getExtreferences().length() < 2
				|| vuln.getExtreferences().length() > 2000 || "".equals(vuln.getExtreferences().trim())
				) {
			return "Please enter proper external refrensce";
		} else if (!TSSVStringUtil.matchPattern(vuln.getCvss3vector(), TSSVStringUtil.PATTERN_CVSS3) || vuln.getCvss3vector().length()>200) {
			return "Please enter proper CVSS vector";
		} else if (vuln.getCvssScore() == 0) {
			return "Please enter proper cvss score";
		} 

		else {
			;
		}

		List<String> vulnCategories = new ArrayList<>();
		try {
			vulnCategories = managaeOptionsService.getOptionList("Vulnerability Category");
		} catch (UserDefinedException e) {
			LOG.info("ManageOptions | ManageOptionsService | Exception ", e);

		}

		if (!vulnCategories.contains(String.valueOf(vuln.getAssessmenttype()))) {
			return "Please select valid Assessment Type";
		}

		List<String> ciaOptions = new ArrayList<>();
		try {
			ciaOptions = managaeOptionsService.getOptionList("CIA");
		} catch (UserDefinedException e) {
			LOG.info("ManageOptions2 | ManageOptionsService2 | Exception ", e);
		}

		String[] cia;
		cia = vuln.getAffectedcia().split(",");

		for (String temp : cia) {
			int ciaIndex = TSSVStringUtil.checkStringInList(ciaOptions, temp);
			if (ciaIndex != -1) {
				ciaOptions.remove(ciaIndex);
			} else {
				return "Please enter proper Affected CIA";
			}
		}

		String[] asvs;
		asvs = vuln.getAsvs().split(",");

		List<String> asvsOptions = new ArrayList<>();
		try {
			asvsOptions = managaeOptionsService.getOptionList("ASVS");
		} catch (UserDefinedException e) {
			LOG.info("ManageOptions | ManageOptionsService | Exception ", e);
		}

		for (String temp : asvs) {

			int asvsIndex = TSSVStringUtil.checkStringInList(asvsOptions, temp);
			if (asvsIndex != -1) {
				asvsOptions.remove(asvsIndex);
			} else {
				return "Please enter proper ASVS Category";
			}
		}

		return null;
	}

	@Override
	public String validateVulnStatus(UpdateStatus vuln, float cvssScore, int programid, int empId) {
		String Severity = "";

		List<String> vulnStatusList = new ArrayList<>();
		vulnStatusList.add("Approved");
		vulnStatusList.add("Rejected");
		vulnStatusList.add("Sent Back");
		vulnStatusList.add("Open");
		vulnStatusList.add("Updated");
		vulnStatusList.add("Access");

		if (!vulnStatusList.contains(vuln.getStatus())) {
			return "Validation failed for Vulnerability Status";
		}

		if ("Approved".equals(vuln.getStatus())) {
			if ((cvssScore > 0 && cvssScore < 4) || cvssScore == 4) {
				Severity = "Low";
			} else if ((cvssScore > 4 && cvssScore < 7) || cvssScore == 7) {
				Severity = "Medium";
			} else if ((cvssScore > 7 && cvssScore < 9) || cvssScore == 9) {
				Severity = "High";
			} else if ((cvssScore > 9 && cvssScore < 10) || cvssScore == 10) {
				Severity = "Critical";
			} else {
				;
			}

			Map<String, Object> program = this.programDAO.getProjectById(programid, empId).get(0);
			List<Map<String, Object>> jobdetialsdata = (List<Map<String, Object>>) program.get("jobdetialsdata");
			Map<String, Object> item = new HashMap<>();
			for (Map<String, Object> temp : jobdetialsdata) {
				if (temp.get("jobtype").equals(Severity)) {
					item = temp;
				}
			}

			int maxPricing = (int) item.get("maxpricing");
			int pricing = (int) item.get("pricing");

			if (vuln.getRejectRemarks() == null || vuln.getRejectRemarks().length() < 2
					|| "".equals(vuln.getRejectRemarks().trim()) || vuln.getRejectRemarks().length() > 100
					|| !TSSVStringUtil.matchPattern(vuln.getRejectRemarks(), TSSVStringUtil.PATTERN_FOR_DESCRIPTION)) {
				return "Remarks are not proper";
			} else if (vuln.getApproved_amount() > maxPricing || vuln.getApproved_amount() < pricing) {
				return "please enter recommanded amount";
			} else {
				;
			}
		} else if ("Rejected".equals(vuln.getStatus())) {
			if (vuln.getRejectRemarks() == null || vuln.getRejectRemarks().length() < 2
					|| vuln.getRejectRemarks().length() > 100 || "".equals(vuln.getRejectRemarks().trim())
					|| !TSSVStringUtil.matchPattern(vuln.getRejectRemarks(), TSSVStringUtil.PATTERN_FOR_DESCRIPTION)) {
				return "please enter proper Remarks it cannot be null and not less than two charachter";
			}
		} else if ("Sent Back".equals(vuln.getStatus())) {
			if (vuln.getRejectRemarks() == null || vuln.getRejectRemarks().length() < 2
					|| vuln.getRejectRemarks().length() > 100 || "".equals(vuln.getRejectRemarks().trim())
					|| !TSSVStringUtil.matchPattern(vuln.getRejectRemarks(), TSSVStringUtil.PATTERN_FOR_DESCRIPTION)) {
				return "please enter proper Remarks it cannot be null and leangth should not be less than 2";
			}
		} else {
			;
		}

		return null;
	}

	@Override
	public void provideAccess(int empid, Date date, int vulnid, int login_id, int access_to) {
		this.bountyDAO.provideAccess(empid, date, vulnid, login_id, access_to);
	}
	
	@Override
	public boolean isEmployeePresent(int access_to, int login_id, int vulnid) {
		return this.bountyDAO.isEmployeePresent(access_to,login_id,vulnid);
	}
	
	@Override
	   public void deleteAccess(int access_to, int emp_id,int vulnid) {
	       this.bountyDAO.deleteAccess(access_to, emp_id, vulnid);	       
	   }
	

	
}
	
	


