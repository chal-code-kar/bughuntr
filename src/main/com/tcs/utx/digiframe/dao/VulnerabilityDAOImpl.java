package com.tcs.utx.digiframe.dao;

import java.sql.Timestamp;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import javax.sql.DataSource;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataAccessException;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

import com.tcs.utx.digiframe.model.Vulnerability;
import com.tcs.utx.digiframe.service.BrandingDetailsService;
import com.tcs.utx.digiframe.service.PermissionHelperService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Repository
public class VulnerabilityDAOImpl implements VulnerabilityDAO {
	

	private static final Logger LOG = LoggerFactory.getLogger(VulnerabilityDAOImpl.class);

	private static final String ERROR_MSG_1 = "VulnerabilityDAOImpl | Exception in  reportvuln - ";

	private static final String ERROR_MSG_2 = "VulnerabilityDAOImpl | Exception in  getAllvulnerabilities - ";

	private static final String ERROR_MSG_3 = "VulnerabilityDAOImpl | Exception in  getVulnerabilityById - ";

	private static final String ERROR_MSG_4 = "VulnerabilityDAOImpl| Exception in   getVulnByProject- ";

	private static final String ERROR_MSG_5 = "VulnerabilityDAOImpl| Exception in   updateVulnStatus- ";

	private static final String ERROR_MSG_6 = "VulnerabilityDAOImpl| Exception in   isVulnReported- ";

	private static final String ERROR_MSG_7 = "VulnerabilityDAOImpl| Exception in   getVulnByProject- ";

	private static final String ERROR_MSG_8 = "VulnerabilityDAOImpl| Exception in  updateVulnerability- ";

	private static final String ERROR_MSG_9 = "VulnerabilityDAOImpl| Exception in   getChange- ";

	private static final String ERROR_MSG_10 = "VulnerabilityDAOImpl| Exception in  provideAccess- ";

	private static final String ERROR_MSG_11 = "VulnerabilityDAOImpl| Exception in  hasTempAccess- ";

	private static final String ERROR_MSG_12 = "VulnerabilityDAOImpl| Exception in   getStatistic- ";
	
	private static final String ERROR_MSG_13 = "VulnerabilityDAOImpl | Exception in deleteAccess - ";

	private JdbcTemplate jdbcTemplate;

	private String TEXT_APPROVED = "Approved";

	private String TEXT_REJECTED = "Rejected";

	private String TEXT_SENT_BACK = "Sent Back";

	private String TEXT_STATUS = "status";

	private String TEXT_CREATEDDT = "createddt";

	private String TIME_FORMAT = "%02d Days %02d:%02d:%02d";
	
	@Autowired
	private BrandingDetailsService brandingService;
	

	@Autowired
	public void setDataSource(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate(dataSource);
	}

	@Override
	public int reportvuln(Vulnerability detail) {
		

			jdbcTemplate.update(BugHuntrQueryConstants.INSERT_VULN, detail.getProgramid(), detail.getResearcherid(),
					detail.getTitle(), detail.getAssessmenttype(), detail.getDescription(), detail.getReplication(),
					detail.getImpact(), detail.getRemediation(), detail.getExtreferences(), detail.getRemarks(),
					detail.getIdentificationdt(), detail.getCvss3vector(), detail.getPortidentified(),
					detail.getCvssScore(), detail.getType(), detail.getAffectedcia(), detail.getVulnerabilitytype(),
					detail.getAsvs(), detail.getResearcherid(), detail.getResearcherid(), " Reported Vulnerability");

			int vulnSr = (jdbcTemplate.queryForObject(BugHuntrQueryConstants.GET_RECENT_SRNO, Integer.class));

			return vulnSr;
		
	}

	@Override
	public List<Map<String, Object>> getAllvulnerabilities() {
		try {
			List<Map<String, Object>> data = jdbcTemplate.queryForList(BugHuntrQueryConstants.GET_ALL_VULN);
			return data;
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_2, e);
			return null;
		}
	}

	@Override
	public List<Map<String, Object>> getVulnerabilityById(int id) {
		try {
			List<Map<String, Object>> data = jdbcTemplate.queryForList(BugHuntrQueryConstants.GET_VULN_BY_ID, id);
			List<Map<String, Object>> history = jdbcTemplate
					.queryForList(BugHuntrQueryConstants.GET_HISTORY_BASED_ON_ID, id);
			List<Map<String, Object>> hasAccess = jdbcTemplate.queryForList(BugHuntrQueryConstants.getTempAccessList,
					id);
			List<Map<String, Object>> vulnStatistics = jdbcTemplate.queryForList(BugHuntrQueryConstants.vulnStatistics,
					id);

			Map<String, Object> stats =  null;
			if(vulnStatistics.size() != 0) {
				stats = getStatistics(vulnStatistics);
			}
		
			if(data.size() != 0) {
				data.get(0).put("hasAccess", hasAccess);
				if (data.size() == 0) {
					return null;
				} else {
					data.get(0).put("history", history);
					data.get(0).put("stats", stats);
					return data;
				}
			}
			return null;
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_3, e);
			return null;

		}
	}

	@Override
	public List<Map<String, Object>> getVulnByProject(int projectid) {
		try {

			List<Map<String, Object>> data = jdbcTemplate.queryForList(BugHuntrQueryConstants.GET_VULN_BY_PROJECT,
					projectid);
			for (Map<String, Object> temp : data) {
				List<Map<String, Object>> history = jdbcTemplate
						.queryForList(BugHuntrQueryConstants.GET_HISTORY_BASED_ON_ID, (int) temp.get("id"));
				temp.put("history", history);
			}
			return data;
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_4, e);
			return null;
		}
	}


	@Override
	public void updateVulnStatus(int srno, String status, int approver, int approved_amount, String rejectRemarks) {
		try {
			List<Map<String, Object>> data = jdbcTemplate.queryForList(BugHuntrQueryConstants.GET_VULN_BY_ID, srno);
			int emp_id = (int) data.get(0).get("researcherid");
			List<Map<String, Object>> pnts = jdbcTemplate.queryForList(BugHuntrQueryConstants.getPoints, emp_id);
			int pts = (int) pnts.get(0).get("points");
			float cvss = (float) data.get(0).get("cvss_score");

			String remarks = "";
			if (TEXT_APPROVED.equals(status)) {
				remarks = "Vulnerability is accepted and " + String.valueOf(data.get(0).get("researcherid"))
						+ " is rewarded with " + String.valueOf(approved_amount) + " GEMS with comments \""
						+ rejectRemarks + "\"";
			} else if (TEXT_REJECTED.equals(status)) {
				remarks = "Vulnerability is rejected with comments \"" + rejectRemarks + "\" ";
			} else if (TEXT_SENT_BACK.equals(status)) {
				remarks = "Vulnerability is sent back with comments \"" + rejectRemarks + "\" ";
			} else {
				;
			}

			if (!((String) data.get(0).get(TEXT_STATUS)).equals(status)) {
				jdbcTemplate.update(BugHuntrQueryConstants.UPDATE_VULN_STATUS, status, srno, srno, status, approver,
						remarks);
				jdbcTemplate.update(BugHuntrQueryConstants.UPDATE_REWARD, srno);
				if (TEXT_APPROVED.equals(status)) {
					jdbcTemplate.update(BugHuntrQueryConstants.INSERT_REWARD, srno, srno, approver, approved_amount);
					if (cvss >= 0.1 && cvss < 3.9) {
						jdbcTemplate.update(BugHuntrQueryConstants.updatePoints, (pts + 1), emp_id);
					} else if (cvss >= 4.0 && cvss < 6.9) {
						jdbcTemplate.update(BugHuntrQueryConstants.updatePoints, (pts + 7), emp_id);
					} else if (cvss >= 7.0 && cvss < 8.9) {
						jdbcTemplate.update(BugHuntrQueryConstants.updatePoints, (pts + 9), emp_id);
					} else if (cvss >= 9.0 && cvss < 10.0) {
						jdbcTemplate.update(BugHuntrQueryConstants.updatePoints, (pts + 17), emp_id);
					} else {
						;
					}
				}
			}
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_5, e);

		}

	}

	@Override
	public boolean isVulnReported(int userid, int srno) {
		try {
			List<Map<String, Object>> ifVulnReported = jdbcTemplate.queryForList(BugHuntrQueryConstants.ifVulnReported,
					userid, srno);
			if (ifVulnReported.size() > 0) {
				return true;
			} else {
				return false;
			}
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_6, e);

			return false;
		}

	}

	@Override
	public int updateVulnerability(Vulnerability detail) {
		
try {
			String changes = getChange(detail);

			jdbcTemplate.update(BugHuntrQueryConstants.updateVuln, detail.getTitle(), detail.getAssessmenttype(),
					detail.getDescription(), detail.getReplication(), detail.getImpact(), detail.getRemediation(),
					detail.getExtreferences(), detail.getRemarks(), detail.getCvss3vector(), detail.getPortidentified(),
					detail.getCvssScore(), detail.getType(), detail.getAffectedcia(), detail.getVulnerabilitytype(),
					detail.getAsvs(), detail.getId(), detail.getId(), detail.getResearcherid(),
					detail.getResearcherid(), changes);

			return 0;
}catch(DataAccessException e) {
	LOG.error(ERROR_MSG_7,e);
	return -1;
}
	}

	@Override
	public List<Map<String, Object>> getVulnCategory() {
		try {
			List<Map<String, Object>> data = jdbcTemplate.queryForList(BugHuntrQueryConstants.getVulnCategory);
			return data;
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_8, e);
			return null;
		}

	}

	public String getChange(Vulnerability detail) {
		try {
			String changes = "";
			List<Map<String, Object>> vulnData = getVulnerabilityById(detail.getId());
			Map<String, Object> data = vulnData.get(0);
			if (!data.get("title").equals(detail.getTitle())) {
				changes = changes + ", Title";
			}
			if (!data.get("affectedcia").equals(detail.getAffectedcia())) {
				changes = changes + ", Impacted Severity Property";
			}
			if ((int) data.get("assessmenttype") != detail.getAssessmenttype()) {
				changes = changes + ", Vulnerability Category";
			}
			if (!data.get("asvs").equals(detail.getAsvs())) {
				changes = changes + ", ASVS Categories";
			}
			if (!data.get("cvss3vector").equals(detail.getCvss3vector())) {
				changes = changes + ", CVSS Vector";
			}
			float score = (float) data.get("cvss_score");
			if (score != (float) detail.getCvssScore()) {
				changes = changes + ", CVSS Score";
			}
			if (!data.get("description").equals(detail.getDescription())) {
				changes = changes + ", Description";
			}
			if (!data.get("extreferences").equals(detail.getExtreferences())) {
				changes = changes + ", Attack Urls";
			}
			if (!data.get("impact").equals(detail.getImpact())) {
				changes = changes + ", Impact";
			}
			if (!data.get("remarks").equals(detail.getRemarks())) {
				changes = changes + ", Remarks/References";
			}
			if (!data.get("remediation").equals(detail.getRemediation())) {
				changes = changes + ", Suggessted Remediation";
			}
			if (!data.get("replication").equals(detail.getReplication())) {
				changes = changes + ", Steps to Replicate";
			}
			if (changes.length() > 1) {
				changes = changes.substring(1, changes.length());
			}

			return changes;
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_9, e);
			return ERROR_MSG_9;
		}

	}

	@Override
	public void provideAccess(int empid, Date date, int vulnid, int login_id, int access_to) {
		try {
			if(empid == access_to) {
			jdbcTemplate.update(BugHuntrQueryConstants.isEmployeePresent, boolean.class,access_to,login_id);
			}
			List<Map<String, Object>> hasAccessEntry = jdbcTemplate.queryForList(BugHuntrQueryConstants.hasAccessEntry,
					empid, vulnid);
			if (hasAccessEntry.size() > 0) {
				jdbcTemplate.update(BugHuntrQueryConstants.updateTempAccess, date, vulnid, empid);
			} else {
				jdbcTemplate.update(BugHuntrQueryConstants.provideTempAccess, vulnid, empid, date, login_id);
			}
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_10, e);
		}
	}

	public Map<String, Object> getStatistics(List<Map<String, Object>> stats) {
		try {
			Map<String, Object> retData = new HashMap<>();

			if (TEXT_APPROVED.equals(stats.get(0).get(TEXT_STATUS))
					|| TEXT_REJECTED.equals(stats.get(0).get(TEXT_STATUS))) {
				LocalDateTime lastDate = ((Timestamp) stats.get(0).get(TEXT_CREATEDDT)).toLocalDateTime();
				LocalDateTime reportedDate = ((Timestamp) stats.get(stats.size() - 1).get(TEXT_CREATEDDT))
						.toLocalDateTime();
				long millis = Duration.between(reportedDate, lastDate).toMillis();

				String totalTime = String.format(TIME_FORMAT, TimeUnit.MILLISECONDS.toDays(millis),
						TimeUnit.MILLISECONDS.toHours(millis)
								- TimeUnit.DAYS.toHours(TimeUnit.MILLISECONDS.toDays(millis)),
						TimeUnit.MILLISECONDS.toMinutes(millis)
								- TimeUnit.HOURS.toMinutes(TimeUnit.MILLISECONDS.toHours(millis)),
						TimeUnit.MILLISECONDS.toSeconds(millis)
								- TimeUnit.MINUTES.toSeconds(TimeUnit.MILLISECONDS.toMinutes(millis)));
				retData.put("acceptanceTime", totalTime);
			}

			int differedIndex = -1;

			for (int i = 0; i < stats.size(); i++) {
				if (TEXT_SENT_BACK.equals(stats.get(i).get(TEXT_STATUS))) {
					differedIndex = i;
					break;
				}
			}
			if (differedIndex != -1) {
				for (int i = 0; i < differedIndex; i++) {
					if ("Updated".equals(stats.get(i).get(TEXT_STATUS))) {
						LocalDateTime lastDate = ((Timestamp) stats.get(i).get(TEXT_CREATEDDT)).toLocalDateTime();
						LocalDateTime differedDate = ((Timestamp) stats.get(differedIndex).get(TEXT_CREATEDDT))
								.toLocalDateTime();
						long millis = Duration.between(differedDate, lastDate).toMillis();

						String totalTime = String.format(TIME_FORMAT, TimeUnit.MILLISECONDS.toDays(millis),
								TimeUnit.MILLISECONDS.toHours(millis)
										- TimeUnit.DAYS.toHours(TimeUnit.MILLISECONDS.toDays(millis)),
								TimeUnit.MILLISECONDS.toMinutes(millis)
										- TimeUnit.HOURS.toMinutes(TimeUnit.MILLISECONDS.toHours(millis)),
								TimeUnit.MILLISECONDS.toSeconds(millis)
										- TimeUnit.MINUTES.toSeconds(TimeUnit.MILLISECONDS.toMinutes(millis)));
						retData.put("disputeTime", totalTime);
						break;
					}
				}
			}

			String data = new String();
			long totalMillis = 0, count = 0, averageMillis = 0;

			for (int i = 0; i < stats.size()-1; i++) {
				if (TEXT_SENT_BACK.equals(stats.get(i).get(TEXT_STATUS))
						|| TEXT_APPROVED.equals(stats.get(i).get(TEXT_STATUS))
						|| TEXT_REJECTED.equals(stats.get(i).get(TEXT_STATUS))) {
					LocalDateTime lastDate = ((Timestamp) stats.get(i).get(TEXT_CREATEDDT)).toLocalDateTime();
					LocalDateTime previousDate = ((Timestamp) stats.get(i + 1).get(TEXT_CREATEDDT)).toLocalDateTime();
					long millis = Duration.between(previousDate, lastDate).toMillis();

					totalMillis = totalMillis + millis;
					count = count + 1;
					data = data.concat((String) stats.get(i).get(TEXT_STATUS));
					data = data.concat(" --> ");
					data = data.concat((String) stats.get(i + 1).get(TEXT_STATUS));
					data = data.concat(", ");
				}
			}

			if (count != 0) {
				averageMillis = totalMillis / count;

				String AverageTime = String.format(TIME_FORMAT, TimeUnit.MILLISECONDS.toDays(averageMillis),
						TimeUnit.MILLISECONDS.toHours(averageMillis)
								- TimeUnit.DAYS.toHours(TimeUnit.MILLISECONDS.toDays(averageMillis)),
						TimeUnit.MILLISECONDS.toMinutes(averageMillis)
								- TimeUnit.HOURS.toMinutes(TimeUnit.MILLISECONDS.toHours(averageMillis)),
						TimeUnit.MILLISECONDS.toSeconds(averageMillis)
								- TimeUnit.MINUTES.toSeconds(TimeUnit.MILLISECONDS.toMinutes(averageMillis)));

				retData.put("AverageTime", AverageTime);
			}

			return retData;
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_11, e);
			return null;

		}
	}

	@Override
    public boolean hasTempAccess(int emp_id, int srno) {
    	try {
        List<Map<String, Object>> hasTempAccess = jdbcTemplate.queryForList(BugHuntrQueryConstants.hasTempAccess, emp_id, srno);
        if (hasTempAccess.size() > 0) {
            return true;
        } else {
            return false;
        }
    }catch(DataAccessException e) {
    	LOG.error(ERROR_MSG_12, e);
    	return false;
    	
    }

}
	@Override
	public boolean isEmployeePresent(int access_to,int login_id, int vulnid) {
		List<Boolean> temp = new ArrayList<>();
		temp = this.jdbcTemplate.queryForList(BugHuntrQueryConstants.isEmployeePresent, Boolean.class,new Object[] {access_to,login_id,vulnid});
		return temp.get(0);
	}
	

	
	@Override
	public void deleteAccess(int access_to, int emp_id, int vulnid) {
		boolean isGuest = brandingService.isUserGuest();
		if (isGuest) {
        LOG.error("FORBIDDEN");
		}

		
		try {
			jdbcTemplate.update(BugHuntrQueryConstants.AccessDelete, access_to, emp_id, vulnid);
		} catch (DataAccessException e) {
			LOG.error(ERROR_MSG_13, e);
		}

	}
	
}
