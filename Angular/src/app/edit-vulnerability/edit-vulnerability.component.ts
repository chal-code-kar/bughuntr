import { DatePipe } from '@angular/common';
import { HttpClient } from '@angular/common/http';
import { Component, OnInit } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { MessageService } from 'primeng/api';
import { environment } from '../../environments/environment';
import { Globals } from '../globals';

import { TssvcommonvalidatorService } from '../services/tssvcommonvalidator.service';


@Component({
  selector: 'app-edit-vulnerability',
  templateUrl: './edit-vulnerability.component.html',
  styleUrls: ['./edit-vulnerability.component.scss']
})
export class EditVulnerabilityComponent implements OnInit {

  active4 = 0;
  vulnerability = {
    "id": 0,
    "asvs": null,
    "programid": 0,
    "title": '',
    "assessmenttype": '',
    "submodule": '',
    "module": '',
    "description": '',
    "replication": '',
    "impact": '',
    "remediation": '',
    "extreferences": '',
    "remarks": '',
    "identificationdt": new Date(),
    "createddt": new Date(),
    "updateddt": null,
    "active": '',
    "cvss3vector": '',
    "status": '',
    "updatedby": null,
    "portidentified": '',
    "cvssScore": 0,
    "type": null,
    "affectedcia": null,
    "vulnerabilitytype": null,
    "crnumber": null,
    "history": [],
    "cvss_score":0,
    "bprogramme_name":'',
    "isEditable":false,
  };
  ProgramList: any;
  assessmenttype = [];
  ASVSList = [];
  currentstatus = [];
  vulntype = [];
  cia = [];
  type = [];

  asvs: any = [];
  selectedCIA: any;
  identificationdt = new Date();
  srno: number = 0;
  attackURLs: any[] = [];
  remediations: any[] = [];
  categories = [
    { name: 'Submission', code: 'SB' },
    { name: 'Change', code: 'CH' },
    { name: 'Dispute', code: 'DP' },
    { name: 'Reward', code: 'RW' }
  ];
  cat = { 'test': 'test' };
  history: any[] = [];
  data: { date: '', data: any[] }[] = [];
  NotAccessible = false;
  VulnCategory;
  dropdown;
  ciadropdown=[];

  constructor(private http: HttpClient,
    private route: ActivatedRoute,
    private messageService: MessageService,
    private datePipe: DatePipe,
    private globals: Globals,
    private router: Router,
    private tssvcommonvalidatorService:TssvcommonvalidatorService) { }

  ngOnInit(): void {

    var Roles=JSON.stringify(this.globals.roles)

    if(!Roles.includes("ROLE_Researcher"))
    {
      this.router.navigate(["403"])
    }


    this.http.post(environment.apiURL + 'getAllOptions',"Vulnerability").subscribe(response => {
      this.dropdown = response;
      this.cia = this.dropdown.CIA;
      this.ASVSList = this.dropdown.ASVS;
      this.VulnCategory = this.dropdown.vulncat;
    })


    this.srno = this.route.snapshot.params['srno'];

    this.getVuln();

    this.http.get(environment.apiURL + 'vulnerabilityCategories').subscribe(response => {
      this.VulnCategory = response;
    })
  }

  getVuln() {
    this.http.get<any>(environment.apiURL + 'vulnerabilities/' + this.srno).subscribe(response => {
      this.data = [];
      this.vulnerability = response;
      if (response == null) {
        this.NotAccessible = true;
      } else {
        this.selectedCIA = this.vulnerability.affectedcia.split(',');
        this.asvs = this.vulnerability.asvs.split(',');



        this.attackURLs = this.vulnerability.extreferences.split(":==:");
        this.remediations = this.vulnerability.remediation.split(":==:");
        this.history = this.vulnerability.history;
        for (var i = 0; i < this.history.length; i++) {
          this.history[i].createddt = this.datePipe.transform(this.history[i].createddt, 'mediumDate')
        }
        var distinctDate = this.history.map((item: any) => item.createddt).filter((value: any, index: any, self: string | any[]) => self.indexOf(value) === index);
        for (var i = 0; i < distinctDate.length; i++) {
          this.data.push({ date: distinctDate[i], data: [] });
        }
        for (var i = 0; i < this.history.length; i++) {
          var index = this.data.findIndex(x => x.date === this.history[i].createddt);
          this.data[index].data.push(this.history[i]);
        }
        this.vulnerability.cvssScore = this.vulnerability.cvss_score
      }
    }, error =>{
      this.messageService.add({ severity: 'error', detail: error.error.error });
    })
  }

  newUrl;
  newRemediation;

  addUrl() {
    if(this.newUrl == undefined || this.newUrl.trim() == ''){
      this.messageService.add({ severity: 'error', detail: 'URL can\'t be empty' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("url", this.newUrl)) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid URL' });
    } else {
      this.attackURLs.push(this.newUrl);
      this.newUrl = '';
    }
  }
  deleteUrl(i) {
    this.attackURLs.splice(i, 1);
  }

  addRemediation() {
    if(this.newRemediation == undefined || this.newRemediation.trim() == ''){
      this.messageService.add({ severity: 'error', detail: 'Please Enter Remediation' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("Markdownregx", this.newRemediation)) {
      this.messageService.add({ severity: 'error', detail: 'only following character in remedition [a-zA-Z0-9 #\-_*=.+:!\[\]()\n,&\'\"\|\/?\\%^`;~$@]' });
    } else {
      this.remediations.push(this.newRemediation);
      this.newRemediation = "";
    }
  }
  deleteRemediation(i) {
    this.remediations.splice(i, 1);
  }

  validateReportVulnDetails() {
    var flaggeneralvalidate = false;
    if (this.vulnerability.title == null || this.vulnerability.title.trim() == '') {
      this.messageService.add({ severity: 'error', detail: 'Please enter title' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("alphanumericspace", this.vulnerability.title)) {
      this.messageService.add({ severity: 'error', detail: 'Only following characters are allowed in title 0-9 a-z A-Z <space>' });
    } else if (this.vulnerability.title.length> 1000) {
        this.messageService.add({ severity: 'error', detail: 'Vulnerability title can have maximum 1000 characters' });
    } else if (this.vulnerability.description == null || this.vulnerability.description.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Description' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("description", this.vulnerability.description)) {
      this.messageService.add({ severity: 'error', detail: 'only following characters allowed in Description .a-zA-Z0-9_()&,-:/ <space>' });
    } else if (this.vulnerability.title.length> 10000) {
      this.messageService.add({ severity: 'error', detail: 'Vulnerability description can have maximum 10000 characters' });
    } else if (this.vulnerability.cvssScore < 0 || this.vulnerability.cvssScore > 10) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid CVSS Score' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("numeric", this.vulnerability.cvssScore)) {
      this.messageService.add({ severity: 'error', detail: 'only number less than 10 is allowed' });
    } else if (this.vulnerability.cvss3vector == null || this.vulnerability.cvss3vector.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid CVSS Score' });
    } else if (this.vulnerability.cvss3vector.length>200 || !this.tssvcommonvalidatorService.isRegexValid("cvss3", this.vulnerability.cvss3vector)) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid CVSS Vector' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("alphanumericspace_", this.vulnerability.assessmenttype)) {
      this.messageService.add({ severity: 'error', detail: 'Only following characters are allowed in title 0-9 a-z A-Z _ <space>' });
    } else if (this.vulnerability.affectedcia == null || this.vulnerability.affectedcia.length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please select Impacted Security Property' });
    } else if (this.vulnerability.asvs == null || this.vulnerability.asvs.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please select ASVS List' });
    } else if (this.vulnerability.impact == null || this.vulnerability.impact.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Impact' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("description", this.vulnerability.impact)) {
      this.messageService.add({ severity: 'error', detail: 'only following character are allowed in Impact field .a-zA-Z0-9_()&,-:/ <space>' });
    } else if (this.vulnerability.impact.trim().length == 10000) {
      this.messageService.add({ severity: 'error', detail: 'Impact can have maximum 10000 characters' });
    } else if (this.vulnerability.extreferences == null || this.vulnerability.extreferences.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Attack URL' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("commaSeparatedUrl", this.vulnerability.extreferences)) {
      this.messageService.add({ severity: 'error', detail: 'only URLs are accepted' });
    } else if (this.vulnerability.extreferences.length>2000) {
      this.messageService.add({ severity: 'error', detail: ' Attack URLs can have maximum 2000 characters' });
    } else if (this.vulnerability.replication == null || this.vulnerability.replication.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Replication Steps' });
    } else if (this.vulnerability.remediation == null || this.vulnerability.remediation.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Remedition' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("Markdownregx", this.vulnerability.remediation)) {
      this.messageService.add({ severity: 'error', detail: 'only following character in remedition a-zA-Z0-9 #\-_*=.+:!\[\]()\n,&\'\"\|\/?\\%^`;~$@ <space>' });
    } else if (this.vulnerability.remediation.trim().length > 10000) {
      this.messageService.add({ severity: 'error', detail: 'Remediation can have maximum 10000 characters' });
    } else {
      flaggeneralvalidate = true;
    }
    return flaggeneralvalidate;
  }

  saveVuln() {
    this.vulnerability.history = [];
    this.vulnerability.affectedcia = '';
    this.vulnerability.asvs = '';

    for(var i=0;i<this.selectedCIA.length;i++){
      this.vulnerability.affectedcia = this.vulnerability.affectedcia + "," + this.selectedCIA[i];
    }
    this.vulnerability.affectedcia= this.vulnerability.affectedcia.slice(1,this.vulnerability.affectedcia.length);

    for(var i=0;i<this.asvs.length;i++){
      this.vulnerability.asvs = this.vulnerability.asvs + "," + this.asvs[i];
    }
    this.vulnerability.asvs=this.vulnerability.asvs.slice(1,this.vulnerability.asvs.length);
    var attackurl = '';
    for (var i = 0; i < this.attackURLs.length; i++) {
      attackurl = attackurl + ':==:' + this.attackURLs[i];
    }
    this.vulnerability.extreferences = attackurl.substring(4,attackurl.length);


    var remediation = '';
    for (var i = 0; i < this.remediations.length; i++) {
      remediation = remediation + ':==:' + this.remediations[i];
    }
    this.vulnerability.remediation = remediation.substring(4,remediation.length);

    if(this.validateReportVulnDetails()){
      this.http.post(environment.apiURL + `updatedvulnerabilities/` + this.vulnerability.id, this.vulnerability, { responseType: 'text' }).subscribe(response => {
        this.messageService.add({ severity: 'success', detail: "Vulnerability Updated" });
        this.getVuln();
        let url = "/ViewVulnerability/"+this.srno;
        this.router.navigate([url]);
      }, error => {

        if(error.error){
          this.messageService.add({ severity: 'error', detail: error.error });
        } else{
          this.messageService.add({ severity: 'error', detail: "Something went wrong" });
        }

      });
    }
  }
}
