import { HttpClient } from '@angular/common/http';
import { Component, OnInit } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { MessageService } from 'primeng/api';
import { environment } from '../../environments/environment';
import { Globals } from '../globals';

import { TssvcommonvalidatorService } from '../services/tssvcommonvalidator.service';


@Component({
  selector: 'app-report-vulnerability',
  templateUrl: './report-vulnerability.component.html',
  styleUrls: ['./report-vulnerability.component.scss']
})
export class ReportVulnerabilityComponent implements OnInit {
  active4 = 0;
  vulnerability = {
    id: 0,
    vulnid: '',
    programid: 0,
    empid: 0,
    title: '',
    description: '',
    replication: '',
    remediation: '',
    extreferences: '',
    remarks: '',
    identificationdt: new Date(),
    createddt: new Date(),
    updateddt: new Date(),
    impact: '',
    assessmenttype: {},
    affectedcia: '',
    asvs: '',
    active: '',
    cvss3vector: '',
    cvssScore: 0,
    status: '',
    strAffectedcia: '',
    strcrnumber: '',
    crFreezed: false,
    crCloned: false,
    portidentified: ''
  }


  assessmenttype = [];
  ASVSList = [];
  currentstatus = [];
  vulntype = [];
  cia = [];
  type = [];

  asvs: { key: string; value: string; }[] = [];
  selectedCIA = [];
  identificationdt = new Date();
  ProgramList = [];

  saveVuln() {
   
    this.vulnerability.affectedcia = this.selectedCIA.toString();
    this.vulnerability.asvs = this.asvs.toString();


    this.vulnerability.identificationdt = this.identificationdt;

    this.vulnerability.extreferences = '';
    for (var i = 0; i < this.attackURLs.length; i++) {
      this.vulnerability.extreferences = this.vulnerability.extreferences + ':==:' + this.attackURLs[i];
    }
    this.vulnerability.extreferences = this.vulnerability.extreferences.substring(4, this.vulnerability.extreferences.length);

    this.vulnerability.remediation = '';
    for (var i = 0; i < this.remediations.length; i++) {
      this.vulnerability.remediation = this.vulnerability.remediation + ':==:' + this.remediations[i];
    }
    this.vulnerability.remediation = this.vulnerability.remediation.substring(4, this.vulnerability.remediation.length);

    if (this.validateReportVulnDetails()) {
      this.http.post<any>(environment.apiURL + 'vulnerabilities', this.vulnerability).subscribe(response => {
        this.messageService.add({ severity: 'success', detail: "Vulnerability Reported" });
        this.router.navigate(["/project/"+this.projectid]);
      }, error => {

        if(error.error){
          this.messageService.add({ severity: 'error', detail: error.error });
        } else{
          this.messageService.add({ severity: 'error', detail: "Something went wrong" });
        }
      });
    }
  }

  constructor(private http: HttpClient,
    private router: Router,
    private route: ActivatedRoute,
    private globals: Globals,
    private messageService: MessageService,
    private tssvcommonvalidatorService: TssvcommonvalidatorService) { }

  projectid: any;
  project: any;
  attackURL: any;
  attackURLs: any[] = [];
  remediation: any;
  remediations: any[] = [];
  VulnCategory;
  dropdown;
  ciadropdown=[];
  ngOnInit(): void {

    var Roles=JSON.stringify(this.globals.roles)

    if(!Roles.includes("ROLE_Researcher"))
    {
      this.router.navigate(["403"])
    }

    this.http.post(environment.apiURL + 'getAllOptions',"Vulnerability").subscribe(response => {
      this.dropdown = response;
      this.cia = this.dropdown.CIA;
      this.ASVSList = this.dropdown.ASVS;
      this.VulnCategory = this.dropdown.vulncat;
    })

    this.projectid = this.route.snapshot.params['projectid'];
    this.vulnerability.programid = this.projectid;

    this.http.get(environment.apiURL + `programs/` + this.projectid).subscribe(response => {
      this.project = response;
    }, error =>{
      this.messageService.add({ severity: 'error', detail: error.error.error });
      this.router.navigate(["/ProgramDetails"]);
    })
  }

  addUrl() {
    if(this.attackURL == undefined || this.attackURL.trim() == ''){
      this.messageService.add({ severity: 'error', detail: 'URL can\'t be empty' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("url", this.attackURL)) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid URL' });
    } else {
      this.attackURLs.push(this.attackURL);
      this.attackURL = "";
    }
  }

  deleteUrl(i: number) {
    this.attackURLs.splice(i, 1);
  }

  addRemediation() {
    if(this.remediation == undefined || this.remediation.trim() == ''){
      this.messageService.add({ severity: 'error', detail: 'Please Enter Remediation' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("Markdownregx", this.remediation)) {
      this.messageService.add({ severity: 'error', detail: 'only following character in remedition [a-zA-Z0-9 #\-_*=.+:!\[\]()\n,&\'\"\|\/?\\%^`;~$@]' });
    } else {
      this.remediations.push(this.remediation);
      this.remediation = "";
    }
  }

  deleteRemediation(i: number) {
    this.remediations.splice(i, 1);
  }

  validateReportVulnDetails() {

    var flaggeneralvalidate = false;
    if (this.vulnerability.title == null || this.vulnerability.title.trim() == '') {
      this.messageService.add({ severity: 'error', detail: 'Please enter title' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("alphanumericspace", this.vulnerability.title)) {
      this.messageService.add({ severity: 'error', detail: 'Only following characters are allowed in title 0-9 a-z A-Z <space>' });
    } else if (this.vulnerability.title.length> 1000) {
        this.messageService.add({ severity: 'error', detail: 'Vulnerability title can have maximum 1000 characters' });
    } else if (this.vulnerability.description == null || this.vulnerability.description.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Description' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("description", this.vulnerability.description)) {
      this.messageService.add({ severity: 'error', detail: 'Only following characters allowed in Description .a-zA-Z0-9_()&,-:/ <space>' });
    } else if (this.vulnerability.description.length> 10000) {
      this.messageService.add({ severity: 'error', detail: 'Vulnerability description can have maximum 10000 characters' });
    } else if (this.vulnerability.cvssScore < 0 || this.vulnerability.cvssScore > 10) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid CVSS Score' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("numeric", this.vulnerability.cvssScore)) {
      this.messageService.add({ severity: 'error', detail: 'only number less than 10 is allowed' });
    } else if (this.vulnerability.cvss3vector == null || this.vulnerability.cvss3vector.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid CVSS Score' });
    } else if (this.vulnerability.cvss3vector.length>200 || !this.tssvcommonvalidatorService.isRegexValid("cvss3", this.vulnerability.cvss3vector)) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid CVSS Vector' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("alphanumericspace_", this.vulnerability.assessmenttype)) {
      this.messageService.add({ severity: 'error', detail: 'Only following characters are allowed in title 0-9 a-z A-Z _ <space>' });
    } else if (this.vulnerability.affectedcia == null || this.vulnerability.affectedcia.length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please select Impacted Security Property' });
    } else if (this.vulnerability.asvs == null || this.vulnerability.asvs.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please select ASVS List' });
    } else if (this.vulnerability.impact == null || this.vulnerability.impact.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Impact' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("description", this.vulnerability.impact)) {
      this.messageService.add({ severity: 'error', detail: 'only following character are allowed in Impact field .a-zA-Z0-9_()&,-:/ <space>' });
    } else if (this.vulnerability.impact.trim().length == 10000) {
      this.messageService.add({ severity: 'error', detail: 'Impact can have maximum 10000 characters' });
    } else if (this.vulnerability.extreferences == null || this.vulnerability.extreferences.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Attack URL' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("commaSeparatedUrl", this.vulnerability.extreferences)) {
      this.messageService.add({ severity: 'error', detail: 'only URLs are accepted' });
    } else if (this.vulnerability.extreferences.length>2000) {
      this.messageService.add({ severity: 'error', detail: ' Attack URLs can have maximum 2000 characters' });
    } else if (this.vulnerability.replication == null || this.vulnerability.replication.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Replication Steps' });
    } else if (this.vulnerability.remediation == null || this.vulnerability.remediation.trim().length == 0) {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Remedition' });
    } else if (!this.tssvcommonvalidatorService.isRegexValid("Markdownregx", this.vulnerability.remediation)) {
      this.messageService.add({ severity: 'error', detail: 'only following character in remedition a-zA-Z0-9 #\-_*=.+:!\[\]()\n,&\'\"\|\/?\\%^`;~$@ <space>' });
    } else if (this.vulnerability.remediation.trim().length > 10000) {
      this.messageService.add({ severity: 'error', detail: 'Remediation can have maximum 10000 characters' });
    } else {
      flaggeneralvalidate = true;
    }
    return flaggeneralvalidate;
  }

}
