import { DatePipe } from '@angular/common';
import { HttpClient } from '@angular/common/http';
import { Component, OnInit } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { MessageService } from 'primeng/api';
import { environment } from '../../environments/environment';
import { TssvcommonvalidatorService } from '../services/tssvcommonvalidator.service';

@Component({
  selector: 'app-view-vulnerability',
  templateUrl: './view-vulnerability.component.html',
  styleUrls: ['./view-vulnerability.component.scss']
})
export class ViewVulnerabilityComponent implements OnInit {

  employeeName = '';
  empDetails:any;
  employee_number:any;
  displayName = false;
  active4 = 0;
  empid = 0;
  vulnerability = {
    "id": 0,
    "asvs": '',
    "programid": 0,
    "title": '',
    "assessmenttype": '',
    "submodule": '',
    "module": '',
    "description": '',
    "replication": '',
    "impact": '',
    "remediation": '',
    "extreferences": '',
    "remarks": '',
    "identificationdt": new Date(),
    "createddt": new Date(),
    "updateddt": null,
    "active": '',
    "cvss3vector": '',
    "status": '',
    "updatedby": null,
    "portidentified": '',
    "cvss_score": 0,
    "type": null,
    "affectedcia": '',
    "vulnerabilitytype": null,
    "crnumber": null,
    "history": [],
    "bprogramme_name": '',
    "isEditable": false,
    "canApprove": false,
    "hasAccess": [],
    "stats": {
      "acceptanceTime": '',
      "disputeTime": '',
      "AverageTime": ''
    },
    "researcherid": '',
    "researchername": '',
    "srno": 0
    
  };
  rejectRemarks;
  approvalAmount = 0;
  ProgramList: any;
  assessmenttype = [];
  ASVSList = [];
  currentstatus = [];
  vulntype = [];
  cia = [];
  type = [];
  Severity;
  asvs: any = [];
  selectedCIA: any[] = [];
  identificationdt = new Date();
  srno: number = 0;
  attackURLs: any[] = [];
  remediations: any[] = [];
  categories = [
    { name: 'Submission', code: 'SB' },
    { name: 'Change', code: 'CH' },
    { name: 'Dispute', code: 'DP' },
    { name: 'Reward', code: 'RW' }
  ];
  cat;
  history: any[] = [];
  AccessTillDate: Date;
  data: { date: '', data: any[] }[] = [];
  date: any;
  NotAccessible = false;
  VulnCategory;
  action;
  display;
  project: any;
  programid: any


  totalsearch = [];
  searchremark = [];;
  temp = [];
  constructor(private http: HttpClient,
    private route: ActivatedRoute,
    private datePipe: DatePipe,
    private messageService: MessageService,
    private tssvcommonvalidatorService: TssvcommonvalidatorService,
    private router: Router) { }

  ngOnInit(): void {
    this.srno = this.route.snapshot.params['srno'];
    this.http.get<any>(`assets/DropDownData.json`).subscribe(response => {
      this.assessmenttype = response.assessmenttype;
      this.ASVSList = response.asvs;
      this.currentstatus = response.currentstatus;
      this.vulntype = response.vulntype;
      this.cia = response.cia;
      this.type = response.type;
    })
    this.getVuln();

    this.http.get(environment.apiURL + 'vulnerabilityCategories').subscribe(response => {
      this.VulnCategory = response;
    })
  }

 

  getVuln() {
    this.http.get<any>(environment.apiURL + 'vulnerabilities/' + this.srno).subscribe(response => {
      this.data = [];
      this.vulnerability = response;
      this.programid = this.vulnerability.programid;
      if (response == null) {
        this.NotAccessible = true;
      } else {
        this.selectedCIA = this.vulnerability.affectedcia.split(',');
        this.asvs = this.vulnerability.asvs.split(',');
        
        this.attackURLs = this.vulnerability.extreferences.split(":==:");
        this.remediations = this.vulnerability.remediation.split(":==:");
        this.history = this.vulnerability.history;
        for (var i = 0; i < this.history.length; i++) {
          this.history[i].createddt = this.datePipe.transform(this.history[i].createddt, 'mediumDate')
        }

        var distinctDate = this.history.map((item: any) => item.createddt).filter((value: any, index: any, self: string | any[]) => self.indexOf(value) === index);
        for (var i = 0; i < distinctDate.length; i++) {
          this.data.push({ date: distinctDate[i], data: [] });
        }
        for (var i = 0; i < this.history.length; i++) {
          var index = this.data.findIndex(x => x.date === this.history[i].createddt);
          this.data[index].data.push(this.history[i]);
        }
        this.http.get(environment.apiURL + `programs/` + this.programid).subscribe(response => {
          this.project = response;
        }, error =>{
          this.messageService.add({ severity: 'error', detail: error.error.error });
          this.router.navigate(["/ProgramDetails"]);
        })
      }
      if ((this.vulnerability.cvss_score > 0 && this.vulnerability.cvss_score < 4) || this.vulnerability.cvss_score == 4) {
        this.Severity = 'Low';
      } else if ((this.vulnerability.cvss_score > 4 && this.vulnerability.cvss_score < 7) || this.vulnerability.cvss_score == 7) {
        this.Severity = 'Medium';
      } else if ((this.vulnerability.cvss_score > 7 && this.vulnerability.cvss_score < 9) || this.vulnerability.cvss_score == 9) {
        this.Severity = 'High';
      } else if ((this.vulnerability.cvss_score > 9 && this.vulnerability.cvss_score < 10) || this.vulnerability.cvss_score == 10) {
        this.Severity = 'Critical';
      }
    }, error => {
      this.messageService.add({ severity: 'error', detail: error.error.error });
    })
  }

  openDialog() {
    this.display = true;
  }

  updateStatus() {
    if (this.vulnerabilityapproval()) {
      this.http.post(environment.apiURL + 'updatevulnerabilityStatus/' + this.srno, { status: this.action, approved_amount: this.approvalAmount, rejectRemarks: this.rejectRemarks }, { responseType: 'text' }).subscribe(response => {
        this.messageService.add({ severity: 'success', detail: response });
        this.display = false;
        this.getVuln();
      },error => {
        this.messageService.add({ severity: 'error', detail: error.error });
      });
    }
  }

  vulnerabilityapproval() {
    var flaggeneralvalidate = false;
    if (this.action == 'Approved') {
      var item = this.project.jobdetialsdata.find(o => o.jobtype == this.Severity);
      var minamount = item.pricing;
      var maxammount = item.maxpricing;
      if (this.approvalAmount < minamount || this.approvalAmount > maxammount || !this.tssvcommonvalidatorService.isRegexValid("numeric", this.approvalAmount)) {
        this.messageService.add({ severity: 'error', detail: 'Please enter valid Bounty Amount which is recommnded' });
      } else if (this.rejectRemarks == null || this.rejectRemarks.length == 0) {
        this.messageService.add({ severity: 'error', detail: 'Please enter valid Remarks' });
      } else if (!this.tssvcommonvalidatorService.isRegexValid("description", this.rejectRemarks)) {
        this.messageService.add({ severity: 'error', detail: 'only following character were allowed in remark field .a-zA-Z0-9\s_()&,-:/' });
      }
      else {
        flaggeneralvalidate = true;
      }
      return flaggeneralvalidate;
    } else if (this.action == 'Rejected') {
      if (this.rejectRemarks == null || this.rejectRemarks.length == 0) {
        this.messageService.add({ severity: 'error', detail: 'Please enter valid Remarks' });
      } else if (!this.tssvcommonvalidatorService.isRegexValid("description", this.rejectRemarks)) {
        this.messageService.add({ severity: 'error', detail: 'only following character were allowed in remark field .a-zA-Z0-9\s_()&,-:/' });
      }
      else {
        flaggeneralvalidate = true;
      }
      return flaggeneralvalidate;
    } else if (this.action == 'Sent Back') {
      if (this.rejectRemarks == null || this.rejectRemarks.length == 0) {
        this.messageService.add({ severity: 'error', detail: 'Please enter valid Send Back Remarks' });
      } else if (!this.tssvcommonvalidatorService.isRegexValid("description", this.rejectRemarks)) {
        this.messageService.add({ severity: 'error', detail: 'only following character were allowed in remark field .a-zA-Z0-9\s_()&,-:/' });
      }
      else {
        flaggeneralvalidate = true;
      }
      return flaggeneralvalidate;
    }
  }

  provideAccess() {
    if(this.validateEmployeeAccess() == true){
      this.http.post(environment.apiURL + 'VulnerabilityAccess/' + this.programid + '/' + this.srno, { empid: this.empid, date: this.AccessTillDate }, { responseType: 'text' }).subscribe(response => {
        this.messageService.add({ severity: 'success', detail: response });
        this.empid = 0;
        this.AccessTillDate=null;
        this.display = false;
        this.getVuln();
      }, error => {
          this.messageService.add({ severity: 'error', detail: error.error });
          this.empid = 0;
        this.AccessTillDate=null;
      });
    }
  }

  validateEmployeeAccess() {
    if(this.empid == 0){
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Employee Id' });
    } else if(this.empid.toString().length > 9){
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Employee Id' });
    } else if(this.empid.toString().length < 4){
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Employee Id' });
    }

    else if (this.AccessTillDate > new Date()) {
      return true;
    } else {
      this.messageService.add({ severity: 'error', detail: 'Please enter valid Date' });
    }
    return false;
  }

  deleteAccess(access_to) {
    
    this.http.delete(environment.apiURL + 'deleteAccess/' + access_to + "/" + this.srno, { responseType: 'text' }).subscribe(response => {
      
      this.messageService.add({ severity: 'success', detail: 'Access Deleted Successfully' });
      this.empid = 0;
      this.AccessTillDate=null;
      this.display = false;
      this.getVuln();
    }, error =>{
      this.messageService.add({ severity: 'error', detail: error.error});
    });
  }

  getEmployeeName(){
    if(this.validateEmployeeAccess() == false){
      this.empid = 0;
      this.AccessTillDate=null;
      return;
    }
    this.http.get(environment.apiURL + 'employee/' + this.empid).subscribe(response => {
      this.empDetails = response;
      if(response == null){
        this.messageService.add({ severity: 'error', detail:"Employee is not present in the ETL Data" });
        this.empid = 0;
        this.AccessTillDate=null;
      }
      this.employeeName = this.empDetails[0].full_name;
      this.displayName = true;
 
    }, error => {
        this.messageService.add({ severity: 'error', detail: error.error });
    });

    
  }

}