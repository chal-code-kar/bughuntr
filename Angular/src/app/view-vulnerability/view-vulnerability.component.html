<div class="surface-ground border-top-1 border-bottom-1 border-gray-300 px-4 py-3">
    <div class="flex flex-column md:align-items-center md:justify-content-between md:flex-row">
        <div class="font-medium text-3xl text-900">BB{{vulnerability.programid}} - {{vulnerability.bprogramme_name}}
            (View Vulnerability)</div>
        <div class="mt-3 md:mt-0">
            <button
                *ngIf="vulnerability.status != 'Approved' && vulnerability.status != 'Rejected' && vulnerability.isEditable"
                pButton pRipple style="margin-left: 4px;" [routerLink]="['/EditVulnerability/' + srno]"
                label="Edit" type="button" icon="pi pi-pencil" class="p-button-primary"></button>
            <button
                *ngIf="vulnerability.status != 'Approved' && vulnerability.status != 'Rejected' && vulnerability.status != 'Sent Back' && vulnerability.canApprove"
                pTooltip="Approve" tooltipPosition="top" label="Approve" pButton pRipple style="margin-left: 4px;"
                type="button" icon="pi pi-check" class="p-button-primary"
                (click)="action='Approved';openDialog();"></button>
            <button
                *ngIf="vulnerability.status != 'Rejected' && vulnerability.status != 'Approved' && vulnerability.status != 'Sent Back' && vulnerability.canApprove"
                pTooltip="Reject" tooltipPosition="top" label="Reject" pButton pRipple style="margin-left: 4px;"
                type="button" icon="pi pi-times" class="p-button-primary"
                (click)=" action='Rejected';openDialog()"></button>
            <button
                *ngIf="vulnerability.status != 'Rejected' && vulnerability.status != 'Approved' && vulnerability.status != 'Sent Back' && vulnerability.canApprove"
                pTooltip="Send Back" tooltipPosition="top" label="Send Back" pButton pRipple style="margin-left: 4px;"
                type="button" icon="pi pi-backward" class="p-button-primary"
                (click)=" action='Sent Back';openDialog()"></button>
            <button pTooltip="Back" [routerLink]="['/ViewVulnerabilities/'+ vulnerability.programid]"
                tooltipPosition="top" label="Back" pButton pRipple style="margin-left: 4px;" type="button"
                icon="pi pi-arrow-circle-left" class="p-button-primary"></button>
        </div>
    </div>
</div>

<br>
<div *ngIf="NotAccessible == false">
    <div class="flex flex-wrap">
        <div class="w-full lg:w-12 px-5">
            <ul class="surface-card p-3 m-0 list-none flex overflow-x-auto select-none">
                <li class="pr-3">
                    <a pRipple
                        class="cursor-pointer px-4 py-3 flex align-items-center hover:surface-100 border-round transition-colors transition-duration-150"
                        [ngClass]="{'bg-primary hover:bg-primary': active4 === 0, 'text-700': active4 !== 0}"
                        (click)="active4 = 0">
                        <i class="pi pi-home mr-2"></i>
                        <span class="font-medium">Overview</span>
                    </a>
                </li>
                <li class="flex align-items-center">
                    <div style="width:1px; height: 50%" class="border-right-1 surface-border"></div>
                </li>
                <li class="px-3">
                    <a pRipple
                        class="cursor-pointer px-4 py-3 flex align-items-center hover:surface-100 border-round transition-colors transition-duration-150"
                        [ngClass]="{'bg-primary hover:bg-primary': active4 === 1, 'text-700': active4 !== 2}"
                        (click)="active4 = 1">
                        <i class="pi pi-list mr-2"></i>
                        <span class="font-medium">Impact</span>
                    </a>
                </li>
                <li class="flex align-items-center">
                    <div style="width:1px; height: 50%" class="border-right-1 surface-border"></div>
                </li>
                <li class="px-3">
                    <a pRipple
                        class="cursor-pointer px-4 py-3 flex align-items-center hover:surface-100 border-round transition-colors transition-duration-150"
                        [ngClass]="{'bg-primary hover:bg-primary': active4 === 2, 'text-700': active4 !== 2}"
                        (click)="active4 = 2">
                        <i class="pi pi-check mr-2"></i>
                        <span class="font-medium">Steps to Reproduce</span>
                    </a>
                </li>
                <li class="flex align-items-center">
                    <div style="width:1px; height: 50%" class="border-right-1 surface-border"></div>
                </li>
                <li class="px-3">
                    <a pRipple
                        class="cursor-pointer px-4 py-3 flex align-items-center hover:surface-100 border-round transition-colors transition-duration-150"
                        [ngClass]="{'bg-primary hover:bg-primary': active4 === 3, 'text-700': active4 !== 3}"
                        (click)="active4 = 3">
                        <i class="pi pi-cog mr-2"></i>
                        <span class="font-medium">Remediation</span>
                    </a>
                </li>
                <li class="flex align-items-center">
                    <div style="width:1px; height: 50%" class="border-right-1 surface-border"></div>
                </li>
                <li class="px-3">
                    <a pRipple
                        class="cursor-pointer px-4 py-3 flex align-items-center hover:surface-100 border-round transition-colors transition-duration-150"
                        [ngClass]="{'bg-primary hover:bg-primary': active4 === 4, 'text-700': active4 !== 4}"
                        (click)="active4 = 4">
                        <i class="pi pi-book mr-2"></i>
                        <span class="font-medium">Remarks</span>
                    </a>
                </li>
                <li class="flex align-items-center">
                    <div style="width:1px; height: 50%" class="border-right-1 surface-border"></div>
                </li>
                <li class="flex align-items-center" *ngIf="vulnerability.status != 'Rejected' && vulnerability.status != 'Approved' && vulnerability.canApprove">
                    <div style="width:1px; height: 50%" class="border-right-1 surface-border"></div>
                </li>
                <li class="px-3">
                    <a pRipple
                        class="cursor-pointer px-4 py-3 flex align-items-center hover:surface-100 border-round transition-colors transition-duration-150"
                        [ngClass]="{'bg-primary hover:bg-primary': active4 === 5, 'text-700': active4 !== 5}"
                        (click)="active4 = 5">
                        <i class="pi pi-bell mr-2"></i>
                        <span class="font-medium">History</span>
                    </a>
                </li>
                <li class="flex align-items-center">
                    <div style="width:1px; height: 50%" class="border-right-1 surface-border"></div>
                </li>

            </ul>
        </div>
    </div>

    <br>

    <div class="flex flex-wrap">
        <div class="w-full lg:w-12 px-5">
            <div class="surface-card" *ngIf="active4 == 0" style="padding: 4%;">
                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Title<span style="color: red">*</span>: </label>
                        <div class="col-12 md:col-12">
                            <input pInputText type="text" [(ngModel)]="vulnerability.title" [disabled]="true"
                                placeholder="Enter Title" maxlength="500" style="width: 100% !important;">
                        </div>
                    </div>
                </div>

                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Description<span style="color: red">*</span>: </label>
                        <div class="col-12 md:col-12">
                            <textarea class="col-12 md:col-12" pInputTextarea rows=5
                                [(ngModel)]="vulnerability.description" style="width: 100% !important;"
                                maxlength="50000" [disabled]="true" placeholder="Provide Description"></textarea>
                        </div>
                    </div>
                </div>

                <div class="grid">
                    <div class="grid col-12 md:col-3">
                        <label class="col-12 md:col-12">CVSS Score:</label>
                        <div class="col-12 md:col-12">
                            <p-inputNumber [(ngModel)]="vulnerability.cvss_score" inputId="minmaxfraction"
                                mode="decimal" [disabled]="true" [minFractionDigits]="0" [maxFractionDigits]="2"
                                :[min]="0" :[max]="10"></p-inputNumber>
                        </div>
                    </div>

                    <div class="grid col-12 md:col-9">
                        <label class="col-12 md:col-12">CVSS v3.1 Vector:</label>
                        <div class="col-12 md:col-12">
                            <input pInputText type="text" [(ngModel)]="vulnerability.cvss3vector" [disabled]="true"
                                placeholder="Enter CVSS v3.1 Vector" maxlength="500" style="width: 100% !important;">
                        </div>
                    </div>
                </div>


                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Vulnerability Category<span style="color: red">*</span>:
                        </label>
                        <div class="col-12 md:col-12">
                            <p-dropdown [options]="VulnCategory" placeholder="Select Assessment Type" [disabled]="true"
                                [(ngModel)]="vulnerability.assessmenttype" optionLabel="result"
                                [style]="{'width':'100%'}" optionValue="srno"></p-dropdown>
                        </div>
                    </div>
                </div>

            </div>

            <div class="surface-card" *ngIf="active4 == 1" style="padding: 4%;">
                <div class="grid">
                    <div class="grid col-12 md:col-6">
                        <label class="col-12 md:col-12">Impacted Security Property<span style="color: red">*</span>:
                        </label>
                        <div class="col-12 md:col-12">
                            <p-multiSelect display="chip" [options]="cia" [(ngModel)]="selectedCIA" [disabled]="true"
                                defaultLabel="Select Impacted Security Property" optionLabel="value" optionValue="key"
                                selectedItemsLabel="{0} items selected" autoWidth="false" [style]="{'width':'100%'}">
                            </p-multiSelect>

                            
   
                        </div>
                    </div>
                    <div class="grid col-12 md:col-6">
                        <label class="col-12 md:col-12">ASVS Categories<span style="color: red">*</span>: </label>
                        <div class="col-12 md:col-12">
                            <p-multiSelect display="chip" [options]="ASVSList" [(ngModel)]="asvs" [disabled]="true"
                                defaultLabel="Select Asvs Categories" optionLabel="value" optionValue="key"
                                selectedItemsLabel="{0} items selected" autoWidth="false" [style]="{'width':'100%'}">
                            </p-multiSelect>
                        </div>
                    </div>
                </div>

                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Impact<span style="color: red">*</span>: </label>
                        <div class="col-12 md:col-12">
                            <textarea class="col-12 md:col-12" pInputTextarea rows=5 [(ngModel)]="vulnerability.impact"
                                [disabled]="true" style="width: 100% !important;" maxlength="50000"
                                placeholder="Impact on End users"></textarea>
                         </div>
                    </div>
                </div>
                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Attack URL(s)<span style="color: red">*</span>: </label>
                        <div class="surface-section col-12 md:col-12">
                            <ul class="list-none p-0 m-0">
                                <li class="flex align-items-center py-3 px-2 border-top-1 surface-border flex-wrap"
                                    *ngFor="let url of attackURLs; let i = index">
                                    <div class="text-900 w-full md:w-8 md:flex-order-0 flex-order-1" style="width: 100%; overflow-wrap: break-word;">{{url}}</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="surface-card" *ngIf="active4 == 2" style="padding: 4%;">
                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Steps to Replicate<span style="color: red">*</span>: </label>
                        <div class="col-12 md:col-12">
                            <p-editor [(ngModel)]="vulnerability.replication" [style]="{'height':'320px'}"
                                [readonly]="true"></p-editor>
                        </div>
                    </div>
                </div>
            </div>

            <div class="surface-card" *ngIf="active4 == 3" style="padding: 4%;">
                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Suggested Remediation<span style="color: red">*</span>: </label>
                        <div class="surface-section col-12 md:col-12">
                            <ul class="list-none p-0 m-0">
                                <li class="flex align-items-center py-3 px-2 border-top-1 surface-border flex-wrap"
                                    *ngFor="let remediation of remediations; let i = index">
                                    <div class="text-900 w-full md:w-8 md:flex-order-0 flex-order-1"  style="width: 100%; overflow-wrap: break-word;">{{remediation}}
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="surface-card" *ngIf="active4 == 4" style="padding: 4%;">
                <div class="grid">
                    <div class="grid col-12 md:col-12">
                        <label class="col-12 md:col-12">Remarks/References: </label>
                        <div class="col-12 md:col-12">
                            <p-editor [(ngModel)]="vulnerability.remarks" [style]="{'height':'320px'}"
                                [readonly]="true"></p-editor>
                        </div>
                    </div>
                </div>
            </div>

            <div class="surface-card shadow-2 border-round p-4" *ngIf="active4 == 5" style="padding: 4%;">
                <div class="flex align-items-center justify-content-between mb-4">
                    <div class="text-900 font-medium text-xl">History</div>
                </div>
                <hr />
                <div class="grid p-3">
                    <div class="col-9">
                        <div class="p-5 flex flex-column flex-auto" *ngFor="let val of data">
                            <span class="block text-600 font-medium mb-3">{{val.date}}</span>
                            <ul class="p-0 mx-0 mt-0 mb-4 list-none">
                                <li class="flex align-items-center py-2 border-bottom-1 surface-border"
                                    *ngFor="let content of val.data">
                                    <div
                                        class="w-3rem h-3rem flex align-items-center justify-content-center bg-blue-100 border-circle mr-3 flex-shrink-0">
                                        <i *ngIf="content.status == 'Reported'"
                                            class="pi pi-power-off text-xl text-blue-500"></i>
                                        <i *ngIf="content.status == 'Approved'"
                                            class="pi pi-dollar text-xl text-green-500"></i>
                                        <i *ngIf="content.status == 'Rejected'"
                                            class="pi pi-times text-xl text-blue-500"></i>
                                        <i *ngIf="content.status == 'Updated'"
                                            class="pi pi-refresh text-xl text-blue-500"></i>
                                        <i *ngIf="content.status == 'Sent Back'"
                                            class="pi pi-backward text-xl text-blue-500"></i>
                                    </div>
                                    <span class="text-700">{{content.remarks}}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="surface-card shadow-2 border-round p-4 mb-5"
                            *ngIf="vulnerability.stats.acceptanceTime">
                            <div class="flex justify-content-between align-items-center">
                                <span class="text-lg text-900" *ngIf="vulnerability.status == 'Approved'">
                                    It took <b>{{vulnerability.stats.acceptanceTime}}</b> to reward <span
                                        class="text-blue-900">
                                        <b><span class="text-blue-600" style="text-decoration: underline; cursor: pointer;"
                                                [routerLink]="'/Profile/'+vulnerability.srno">{{vulnerability.researchername}}</span></b>
                                        after vulnerability was reported.
                                    </span>
                                </span>
                                <span class="text-lg text-900" *ngIf="vulnerability.status == 'Rejected'">
                                    It took <b>{{vulnerability.stats.acceptanceTime}}</b> to reject the vulnerability
                                    <span class="text-blue-900"> after it was reported.
                                    </span>
                                </span>
                            </div>
                        </div>
                        <div class="surface-card shadow-2 border-round p-4 mb-5"
                            *ngIf="vulnerability.stats.disputeTime">
                            <div class="flex justify-content-between align-items-center">
                                <span class="text-lg text-900"><b><span class="text-blue-600"
                                            style="text-decoration: underline; cursor: pointer;"
                                            [routerLink]="'/Profile/'+vulnerability.srno">{{vulnerability.researchername}}</span></b>
                                    took <b> {{vulnerability.stats.disputeTime}} </b> to
                                    resolve dispute.</span>
                            </div>
                        </div>
                        <div class="surface-card shadow-2 border-round p-4 mb-5"
                            *ngIf="vulnerability.stats.AverageTime">
                            <div class="flex justify-content-between align-items-center">
                                <span class="text-lg text-900 text-blue-600">Average response time from Program Administrator is
                                    <b>{{vulnerability.stats.AverageTime}}</b></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="surface-card" *ngIf="active4 == 6" style="padding: 4%;">

                <div class="grid">
                    <p-table class="col-12 md:col-8" #dt [value]="vulnerability.hasAccess" styleClass="p-datatable-customers"
                        [rowHover]="true" [rows]="10" [showCurrentPageReport]="true" [rowsPerPageOptions]="[10,25,50]"
                        [paginator]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                        [globalFilterFields]="['avatar','emp_id','count']">
                        <ng-template pTemplate="caption">
                            <div class="grid">
                                <div class="col-12 md:col-8">List of Users</div>
                                <div class="col-12 md:col-4" style="text-align: right;">
                                    <span class="p-input-icon-left">
                                        <i class="pi pi-search"></i>
                                        <input pInputText type="text"
                                            (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                                            placeholder="Search" />
                                    </span>
                                </div>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="header" let-columns>
                            <tr>
                                <th>Employee Id</th>
                                <th style="width: 10%;">Actions</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-item>
                            <tr>
                                <td>{{item.full_name}}({{item.access_to}})</td>
                                <td>
                                    <button pButton pRipple type="button" icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-plain" (click)="deleteAccess(item.access_to)"></button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="2">No Data found.</td>
                            </tr>
                        </ng-template>
                    </p-table>
                    <div class="col-0 md:col-1">
                        <p-divider layout="vertical" ></p-divider>
                    </div>
                    <div class="col-3 flex align-items-center justify-content-center">
                        <div class="p-fluid">
                            <div class="field">
                                <label class="col-12">Employee Id <span style="color: red">*</span>:</label>
                                <input id="EmployeeId" type="number" pInputText [(ngModel)]="empid" minlength="2" maxlength="100" style="width:100%" placeholder="Employee Id" />
                            </div>
                            <div class="field">
                                <label class="col-12 md:col-12">Access Till <span style="color: red">*</span>:</label>
                                <p-calendar inputId="basic" [(ngModel)]="AccessTillDate" [style.width]="'100% !important'" id="AccessTillDate"></p-calendar>
                            </div>
                            <p-button label="Submit" (click)="getEmployeeName()"></p-button>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div *ngIf="NotAccessible == true" style="text-align: center;">
    <h1>You are not authorised to see this page</h1>
</div>

<p-dialog [(visible)]="display" [style]="{width: '50vw'}">
    <ng-template pTemplate="header">
        <h3 *ngIf="action == 'Approved'">
            Approve Reward
        </h3>
        <h3 *ngIf="action == 'Rejected'">
            Rejection Remarks
        </h3>
        <h3 *ngIf="action == 'Sent Back'">
            SendBack Remarks
        </h3>
        <h3 *ngIf="action == 'Access'">
            List of Users
        </h3>
    </ng-template>
    <div *ngIf="action == 'Approved'">
        <div *ngFor="let item of project.jobdetialsdata">
            <li class="pb-1 surface-border" *ngIf="item.jobtype == Severity">
                <b>{{item.jobtype}}</b> : {{item.pricing}} - {{item.maxpricing}} <em>(Recommended)</em>
            </li>
            <li class="pb-1 surface-border" *ngIf="item.jobtype != Severity">
                <b>{{item.jobtype}}</b> : {{item.pricing}} - {{item.maxpricing}}
            </li>
        </div>
        <hr>
        <div class="grid">
            <div class="col-12 md:col-3">
                Gems :
            </div>
            <div class="col-12 md:col-9">
                <input pInputText type="number" [(ngModel)]="approvalAmount" placeholder="Enter Approval Amount"
                    style="width: 100% !important;">
            </div>
            <div class="col-12 md:col-3">
                Remarks :
            </div>
            <div class="col-12 md:col-9">
                <textarea rows="3" cols="30" pInputTextarea [(ngModel)]="rejectRemarks" placeholder="Enter Remarks"
                    style="width: 100% !important;"></textarea>
            </div>
        </div>
    </div>
    <div *ngIf="action == 'Rejected'">
        <div>
            <textarea rows="3" cols="30" pInputTextarea [(ngModel)]="rejectRemarks" placeholder="Enter Remarks"
                style="width: 100% !important;"></textarea>
        </div>
    </div>
    <div *ngIf="action == 'Sent Back'">
        <div>
            <textarea rows="3" cols="30" pInputTextarea [(ngModel)]="rejectRemarks" placeholder="Enter Remarks"
                style="width: 100% !important;"></textarea>
        </div>
    </div>
    <div *ngIf="action == 'Access'">
        <div class="grid">
            <div class="col-12 md:col-3" *ngFor="let item of vulnerability.hasAccess">
                <b>{{item.access_to}}</b>
            </div>
        </div>
        <br>
        <br>
        <div class="grid">
            <div class="col-12 md:col-9 grid">
                <label class="col-12 md:col-4"><b>Employee Id :</b></label>
                <div class="col-12 md:col-6">
                    <input type="number" pInputText [(ngModel)]="empid" minlength="2" maxlength="100" style="width:100%"
                        placeholder="Employee Id" />
                </div>
            </div>
            <div class="col-12 md:col-3">
                <button pButton pRipple type="button" class="p-button-primary" label="Submit" icon="pi pi-plus"
                    (click)="provideAccess()"></button>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button *ngIf="action != 'Access'" pButton pRipple label="Confirm" icon="pi pi-save" class="p-button-text"
            (click)="updateStatus()"></button>
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text p-button-danger"
            (click)="display = false"></button>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="displayName" appendTo="body" [modal]="true" [breakpoints]="{'960px': '75vw', '640px': '100vw'}" [style]="{width: '40vw'}" [closable]="false" [showHeader]="false">
    <div class="flex flex-column align-items-center my-4">
        <span class="flex align-items-center justify-content-center bg-cyan-100 text-cyan-800 mr-3 border-circle mb-3" style="width:64px;height:64px">
            <i class="pi pi-user text-5xl"></i>
        </span>
        <div class="font-medium text-2xl text-900">Employee Name</div>
        <div class="font-medium text-2xl text-600">{{employeeName}}</div>
    </div>
    <p class="line-height-3 p-0 m-0 flex flex-column align-items-center my-4">
        Are you sure, you want to provide access?
    </p>
    <ng-template pTemplate="footer">
        <div class=" border-top-1 surface-border pt-3 flex">
            <button pButton pRipple icon="pi pi-times" (click)="displayName = false; employeeName=''" label="Cancel" class="p-button-outlined w-6 mr-2"></button>
            <button pButton pRipple icon="pi pi-check" (click)="displayName = false; provideAccess()" label="Save" class="w-6 ml-2"></button>
        </div>
    </ng-template>
</p-dialog>